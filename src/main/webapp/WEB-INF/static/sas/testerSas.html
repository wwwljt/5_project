<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tester Sas</title>
    <link href="../layui/css/layui.css" rel="stylesheet" charset="utf-8">

</head>
<body>

<!--添加搜索按钮和搜索框-->
<div class="demoTable" style="margin: 15px;">

    <button class="layui-btn layui-btn-warm" id="btn-remove" lay-event="getCheckData">
        <i class="layui-icon layui-icon-reduce-circle" style="font-size: 20px; color: white;"></i>删除
    </button>

    <span style="margin-left: 80px;">搜索姓名：</span>
    <div class="layui-inline">
        <input class="layui-input" id="searchOne" autocomplete="off">
    </div>

    <span style="margin-left: 80px;">搜索测试计划ID：</span>
    <div class="layui-inline">
        <input class="layui-input" id="searchTwo" autocomplete="off">
    </div>
    <button class="layui-btn" data-type="reload" id="search"><i class="layui-icon layui-icon-search"
                                                                style="font-size: 20px; color: white;"></i>搜索
    </button>
    <button class="layui-btn" data-type="reload" id="resetSearch"><i class="layui-icon layui-icon-refresh"
                                                                     style="font-size: 20px; color: white;"></i>重置
    </button>
</div>

<!--主体-->
<table class="layui-hide" id="testTestSas" lay-filter="TesterSasDemo"></table>

<!--查看模态框-->
<div class="layui-row" id="open_detail_div" style="display:none;">

    <div style="width:400px; margin-left: 50px; text-align: center;">
        <span style="font-family: 华文行楷; text-align: center; font-size: 30px; margin-top: 10px;">SAS测试结果</span>
        <h1 id="resultH1"
            style="font-family: 华文行楷; text-align: center; margin-top: 30px; margin-bottom: 20px;"></h1>
    </div>


    <div id="detail_main" style="height:430px; width:100%;"></div>

</div>

<!--右侧工具栏-->
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="detail">查看</a>
</script>

</body>

<script src="../layui/layui.js" charset="utf-8"></script>
<!--Staticfile CDN（国内）-->
<!--<script src="https://cdn.staticfile.org/echarts/5.3.3/echarts.js"></script>-->
<script src="../layui/js/echarts-5.3.3.js"></script>
<script>

    layui.use(['table'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var util = layui.util;
        var laypage = layui.laypage,
            layer = layui.layer;
        let laydate = layui.laydate;


        // 创建渲染实例
        table.render({
            elem: '#testTestSas'
            , id: 'testTesterSas'
            , url: '/findAllTesterSas'
            , method: 'get'
            , toolbar: true
            , defaultToolbar: ['filter', 'exports', 'print', {
                title: '帮助'
                , layEvent: 'LAYTABLE_TIPS'
                , icon: 'layui-icon-tips'
            }]
            , page: {  // 允许分页
                first: 1,
                limits: [10, 20, 30, 40, 50],  // 规定每页显示的条数
                limit: 10,  // 规定默认显示条数
            }
            , cols: [[
                {type: 'checkbox', fixed: 'left'}
                , {field: 'id', fixed: 'left', width: 80, title: 'ID', sort: true}
                , {field: 'name', width: 80, title: '姓名'}
                , {field: 'phone', width: 120, title: '电话'}
                , {
                    field: 'createTime',
                    width: 170,
                    title: '创建时间',
                    templet: '<div>{{layui.util.toDateString(d.createTime, "yyyy-MM-dd HH:mm:ss") }}</div>'
                }

                , {
                    field: 'forward',
                    sort: true,
                    width: 120,
                    title: '正向得分'
                }

                , {
                    field: 'inversion',
                    sort: true,
                    width: 120,
                    title: '反向得分'
                }

                , {field: 'testPlanId', width: 100, title: '测试计划ID'}
                , {fixed: 'right', title: '操作', width: 125, minWidth: 125, toolbar: '#barDemo'}

            ]]


        });

        // 监听工具条，实现查看,删除功能
        table.on('tool(TesterSasDemo)', function (obj) {    // TesterSasDemo 表示工具列所在表格的 lay-filter 的值
            let data = obj.data;

            // 如果为删除
            if (obj.event === 'del') {  //  绑定事件的名称

                layer.confirm('确认删除ID为' + data.id + '的计划吗?', function (index) {

                    let strIds = "" + data.id;

                    console.log("strIds===" + strIds);

                    layer.close(index);   // 关闭弹框
                    // 向服务端发送删除命令，获取后端
                    // alert("123123");
                    $.ajax({
                        type: 'get',
                        url: "/delDataTesterSas",
                        data: {
                            ids: strIds,
                        },
                        contentType: 'application/json',
                        success: function (data) {

                            console.log(data);

                            if (data == 1) {
                                obj.del();  // 删除对应行（tr）的DOM结构
                                layer.msg('删除成功！', {icon: 1}, {time: 2000});  // icon 为图标，time为弹出框消息停留时间

                            } else {
                                layer.msg('删除失败！', {icon: 2}, {time: 2000});
                            }

                        }
                    })
                });
            }

            // 如果为查看
            else if (obj.event === 'detail') {

                // 打开模态框
                layer.open({
                    type: 1,//类型
                    area: ['500px', '600px'],  //定义宽和高
                    title: '查看信息',  //题目
                    shadeClose: true,  //点击遮罩层关闭
                    content: $('#open_detail_div'),  //打开的内容
                });


                console.log("ret=====" + data.id)

                var forward = data.forward;
                var inversion = data.inversion;
                var score = forward + inversion;
                var string = "";
                if (score < 50) {
                    string = "您的测试结果为：无焦虑症状"
                    $("#resultH1").html(string);
                } else if (score <= 60) {
                    string = "您的测试结果为：轻度焦虑"
                    $("#resultH1").html(string);
                } else if (score <= 70) {
                    string = "您的测试结果为：中度焦虑"
                    $("#resultH1").html(string);
                } else if (score > 70) {
                    string = "您的测试结果为：重度焦虑"
                    $("#resultH1").html(string);
                }


                // $("#resultH1").html(string);


                var chartDom = document.getElementById('detail_main');  // 获取放置图表的dom
                var myChart = echarts.init(chartDom);  // 拿到dom, 初始化eacharts实例
                var option;

                option = {
                    title: {
                        text: 'SAS测试结果',
                        subtext: 'Fake Data',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',

                    },
                    series: [
                        {
                            name: 'SAS焦虑测试',
                            type: 'pie',
                            radius: '50%',
                            data: [
                                {value: forward, name: '正向得分'},
                                {value: inversion, name: '反向得分'}
                            ],
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };

                option && myChart.setOption(option);


            }


        });

        // 批量删除数据
        $("#btn-remove").click(function () {
            let checkStatus = table.checkStatus('testTesterSas');
            if (checkStatus.data.length == 0) {
                console.log("checkData===" + checkStatus.data);
                parent.layer.msg('请先选择要删除的数据行！', {icon: 2, time: 2000});
                return;
            }

            console.log("checkStatus===" + checkStatus.data.id);

            // 对拿到的数据进行处理,转为字符串
            let strIds = '';
            for (let i = 0; i < checkStatus.data.length; i++) {
                strIds += checkStatus.data[i].id + ';';
            }
            strIds = strIds.substring(0, strIds.length - 1);  // 去掉 ; 号

            // 弹出确认删除框
            layer.confirm('确认删除ID为 [' + strIds + '] 的题目吗?', function (index) {

                console.log("strIds===" + strIds)

                parent.layer.msg('删除中...', {icon: 16, shade: 0.3, time: 2000});

                $.ajax({
                    type: 'get',
                    url: "/delDataTesterSas",
                    data: {
                        ids: strIds,
                    },
                    contentType: 'application/json',
                    success: function (data) {

                        console.log(data);

                        if (data !== 0) {
                            layer.closeAll('loading');  // 关闭加载动画
                            window.setTimeout(function () {  // 延时两秒后再执行方法体
                                layer.msg('删除成功！', {icon: 1}, {time: 1000});  // icon 为图标，time为弹出框消息停留时间
                            }, 2000);

                            $(".layui-laypage-btn").click();  //刷新数据
                        } else {
                            layer.closeAll('loading');  // 关闭加载动画
                            window.setTimeout(function () {
                                layer.msg('删除失败！', {icon: 2}, {time: 1000});
                            }, 2000);

                        }

                    }
                })

            })

        });


        // 搜索
        $('#search').click(function () {

            // alert("6666666666666");

            // 获取两个输入框的值
            let one = $('#searchOne').val();
            let two = $('#searchTwo').val();

            if (one == "" && two == "") {
                parent.layer.msg('请输入要搜索的内容！', {icon: 2, time: 2000});
                return false;
            }

            //执行重载
            table.reload('testTesterSas', {
                method: 'get'
                , page: {
                    curr: 1 //重新从第 1 页开始
                }
                , where: {
                    name: one,
                    planId: two,
                }
            });
        });

        // 搜索重置
        $('#resetSearch').click(function () {

            // alert("6666666666666");

            // 获取两个输入框的值
            $('#searchOne').val('');
            $('#searchTwo').val('');

            let one = '';
            let two = '';

            //执行重载
            table.reload('testTesterSas', {
                method: 'get'
                , page: {
                    curr: 1 //重新从第 1 页开始
                }
                , where: {
                    name: one,
                    planId: two,
                }
            });
        })


    })

</script>


</html>