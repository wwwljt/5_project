<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Userinfo</title>
    <link href="../layui/css/layui.css" rel="stylesheet" charset="utf-8">
</head>
<body>

<!--添加搜索按钮和搜索框-->
<div class="demoTable" style="margin: 15px;">


    <button class="layui-btn" id="btn-add"><i class="layui-icon layui-icon-add-circle"
                                              style="font-size: 20px; color: white;"></i>添加
    </button>
    <button class="layui-btn layui-btn-warm" id="btn-remove" lay-event="getCheckData">
        <i class="layui-icon layui-icon-reduce-circle" style="font-size: 20px; color: white;"></i>删除
    </button>

    <span style="margin-left: 80px;">用户编号：</span>
    <div class="layui-inline">
        <input class="layui-input" id="searchQuestion" autocomplete="off">
    </div>

    <span style="margin-left: 80px;">用户名：</span>
    <div class="layui-inline">
        <input class="layui-input" id="createPerson" autocomplete="off">
    </div>
    <button class="layui-btn" data-type="reload" id="search"><i class="layui-icon layui-icon-search"
                                                                style="font-size: 20px; color: white;"></i>搜索
    </button>
    <button class="layui-btn" data-type="reload" id="resetSearch"><i class="layui-icon layui-icon-refresh"
                                                                     style="font-size: 20px; color: white;"></i>重置
    </button>
</div>

<table class="layui-hide" id="testUserinfo" lay-filter="UserinfoDemo"></table>


<!--编辑模态框-->
<div class="layui-row" id="open_edit_div" style="display:none;">

    <div id="add_form" class="layui-form" lay-filter="edit" action="" style="margin-top: 20px;align:center;">

        <div class="layui-form-item">
            <label class="layui-form-label"> ID </label>
            <div class="layui-input-inline" style="width: 65%">
                <input id="deptId" lay-verify="number" readonly="readonly" type="text" name="userId"
                       placeholder="ID"
                       autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">部门名称</label>
            <div class="layui-input-inline" style="width: 65%">
                <select name="dept" lay-filter="DeptZero" id="deptDoor">
                    <option value="11">测试部门</option>
                    <option value="12">财务部门</option>
                    <option value="13">运维部门</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" id="userName" type="text" name="userName"
                       placeholder="请输入用户名" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" id="email" type="text" name="email"
                       placeholder="请输入邮箱" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">电话</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" id="phone" type="text" name="phone"
                       placeholder="请输入电话" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-inline" style="width: 65%">
                <input type="radio" name="sex" value="1" title="男" checked="checked">
                <input type="radio" name="sex" value="0" title="女">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-inline" style="width: 65%">
                <input type="checkbox" name="status" lay-skin="switch" lay-text="可用|失效" value="1">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">用户身份</label>
            <div class="layui-input-inline" style="width: 65%">
                <input type="radio" name="identity" value="1" title="管理员">
                <input type="radio" name="identity" value="2" title="普通角色">
                <input type="radio" name="identity" value="3" title="测试人员">
            </div>
        </div>


        <div class="layui-form-item">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" id="remark" type="text" name="remark"
                       placeholder="请输入备注" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>


        <div class="layui-form-item">
            <div class="layui-input-block" style="margin-left: 150px;">
                <button class="layui-btn" lay-submit lay-filter="update_edit_submit" style="width: 200px;">立即提交</button>
            </div>
        </div>
    </div>
</div>


<!--添加模态框-->
<div class="layui-row" id="open_add_div" style="display:none;">

    <div id="add_form1" class="layui-form" lay-filter="add" action="" style="margin-top: 20px;align:center;">

        <div class="layui-form-item">
            <label class="layui-form-label">部门名称</label>
            <div class="layui-input-inline" style="width: 65%">
                <select name="dept" lay-filter="DeptZero">
                    <option value="11">测试部门</option>
                    <option value="12">财务部门</option>
                    <option value="13">运维部门</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" type="text" name="userName"
                       placeholder="请输入用户名" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" type="text" name="email"
                       placeholder="请输入邮箱" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">电话</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" type="text" name="phoneNumber"
                       placeholder="请输入电话" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-inline" style="width: 65%">
                <input type="radio" name="sex" value="1" title="男" checked="checked">
                <input type="radio" name="sex" value="0" title="女">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-inline" style="width: 65%">
                <div class="layui-input-inline" style="width: 65%">
                    <input required lay-verify="required" id="password" type="text" name="password"
                           placeholder="请输入密码" autofocus
                           class="layui-input" autocomplete="off">
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">用户身份</label>
            <div class="layui-input-inline" style="width: 65%">
                <input type="radio" name="identity" value="1" title="管理员">
                <input type="radio" name="identity" value="2" title="普通角色">
                <input type="radio" name="identity" value="3" title="测试人员" checked>
            </div>
        </div>


        <div class="layui-form-item">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-inline" style="width: 65%">
                <input required lay-verify="required" type="text" name="remark"
                       placeholder="请输入备注" autofocus
                       class="layui-input" autocomplete="off">
            </div>
        </div>


        <div class="layui-form-item">
            <div class="layui-input-block" style="margin-left: 150px;">
                <button class="layui-btn" lay-submit lay-filter="update_add_submit" style="width: 200px;">立即提交</button>
            </div>
        </div>
    </div>
</div>


<!--右侧工具栏-->
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">重置密码</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<!--绑定模板选择器-->
<!--状态栏-->
<script type="text/html" id="buttonTpl">
    {{#  if(d.status == 1){ }}
    <button class="layui-btn layui-btn-xs">可用</button>
    {{#  } else { }}
    <button class="layui-btn layui-btn-primary layui-btn-xs">失效</button>
    {{#  } }}
</script>


</body>

<!--引入layui-->
<script src="../layui/layui.js" charset="utf-8"></script>

<script>

    layui.use(['table'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var util = layui.util;
        var laypage = layui.laypage,
            layer = layui.layer;
        let laydate = layui.laydate;


        // 创建渲染实例
        table.render({
            elem: '#testUserinfo'
            , id: 'Userinfo'
            , url: '/findUserAll'
            , method: 'get'
            , toolbar: true
            , defaultToolbar: ['filter', 'exports', 'print', {
                title: '帮助'
                , layEvent: 'LAYTABLE_TIPS'
                , icon: 'layui-icon-tips'
            }]
            , page: {  // 允许分页
                first: 1,
                limits: [10, 20, 30, 40, 50],  // 规定每页显示的条数
                limit: 10,  // 规定默认显示条数
            }
            , cols: [[
                {type: 'checkbox', fixed: 'left'}
                , {field: 'userId', fixed: 'left', width: 80, title: 'ID', sort: true}
                , {field: 'deptName', width: 100, title: '部门名称'}
                , {field: 'userName', width: 100, title: '用户名'}
                , {
                    field: 'sex',
                    width: 60,
                    title: '性别',
                    templet: function (d) {
                        if (d.sex == 1){
                            return "男";
                        }else {
                            return "女";
                        }
                    }
                }
                , {field: 'phoneNumber', width: 150, title: '手机号'}
                , {field: 'avatar', width: 200, title: '头像'}
                , {field: 'status', width: 100, title: '状态', templet: "#buttonTpl"}
                , {field: 'email', width: 200, title: '邮箱'}
                , {field: 'password', width: 200, title: '密码'}
                , {field: 'salt', width: 200, title: '盐值'}
                , {
                    field: 'roleName',
                    width: 100,
                    title: '角色',
                }
                , {field: 'createBy', width: 80, title: '创建人'}
                , {
                    field: 'createTime',
                    width: 170,
                    title: '创建时间',
                    templet: '<div>{{layui.util.toDateString(d.createTime, "yyyy-MM-dd HH:mm:ss") }}</div>'
                }
                , {field: 'updateBy', width: 80, title: '修改人'}
                , {
                    field: 'updateTime',
                    width: 170,
                    title: '修改时间',
                    templet: '<div>{{layui.util.toDateString(d.updateTime, "yyyy-MM-dd HH:mm:ss") }}</div>'
                }
                , {field: 'remark', width: 150, title: '备注'}
                , {fixed: 'right', title: '操作', width: 200, minWidth: 205, toolbar: '#barDemo'}

            ]]
        });


        // 监听工具条，实现查看,删除,编辑功能
        table.on('tool(UserinfoDemo)', function (obj) {
            let data = obj.data;
            console.log("data====="+data.roleName)

            // 如果为删除
            if (obj.event === 'del') {  //  绑定事件的名称

                layer.confirm('确认删除ID为' + data.userId + '的计划吗?', function (index) {

                    let strIds = "" + data.userId;

                    console.log("strIds===" + strIds);

                    layer.close(index);   // 关闭弹框
                    // 向服务端发送删除命令，获取后端
                    // alert("123123");
                    $.ajax({
                        type: 'get',
                        url: "/delDataUser",
                        data: {
                            ids: strIds,
                        },
                        // data: {
                        //     id: data.id,  // 此处是根据id查询此id是否被删除，故将id传向后端
                        // },
                        contentType: 'application/json',
                        success: function (data) {

                            console.log(data);

                            if (data == 1) {
                                obj.del();  // 删除对应行（tr）的DOM结构
                                layer.msg('删除成功！', {icon: 1}, {time: 2000});  // icon 为图标，time为弹出框消息停留时间

                            } else {
                                layer.msg('删除失败！', {icon: 2}, {time: 2000});
                            }

                        }
                    })
                });
            }

            // 如果为编辑
            else if (obj.event === 'edit') {   // 监听工具条，实现编辑功能

                let form = layui.form;
                form.val("edit", {
                    "userId": data.userId,
                    "dept": data.deptName,
                    "userName": data.userName,
                    "email": data.email,
                    "phone": data.phoneNumber,
                    "sex": data.sex,
                    "status": data.status,
                    "identity": data.roleName,
                    "remark": data.remark,
                });

                $("#deptDoor").val(data.deptName);

                console.log("deptName==="+data.deptName);
                console.log("phoneNumber==="+data.phoneNumber);
                console.log("roleName==="+data.roleName);

                // 判定当前人员身份


                // 判定当前人员所属部门



                // 打开模态框
                layer.open({
                    type: 1,//类型
                    area: ['500px', '650px'],  //定义宽和高
                    title: '编辑信息',  //题目
                    shadeClose: true,  //点击遮罩层关闭
                    content: $('#open_edit_div'),  //打开的内容
                    // btn: ['确定', '取消']
                });


                // 拿到修改后的数据，传给后端
                form.on('submit(update_edit_submit)', function (massage) {
                    console.log("message为：", massage);
                    let data1 = massage.field;

                    $.ajax({
                        type: "post",
                        url: "/editDataUser",
                        // data: JSON.stringify(massage.field),
                        data: {
                            "userId": data1.userId,
                            "deptId": data1.dept,
                            "userName": data1.userName,
                            "email": data1.email,
                            "phoneNumber": data1.phone,
                            "sex": data1.sex,
                            "status": data1.status,
                            "roleId": data1.identity,
                            "updateBy": "CM",
                            "remark": data1.remark,
                        },

                        success: function (msg) {
                            console.log(msg);
                            layer.closeAll();//关闭所有的弹出层
                            if (msg == 1) {
                                layer.msg("修改成功", {icon: 6}, {time: 2000});

                                $(".layui-laypage-btn").click();  // CSH自创

                            } else {
                                layer.msg("修改失败", {icon: 5}, {time: 2000});
                            }
                        }
                    })
                    return false
                });

            }

            // 如果为查看
            else if (obj.event === 'detail') {

                let id = data.id;
                let testName = data.testName;
                let testCode = data.testCode;
                let testBegin = data.testBegin;
                let testEnd = data.testEnd;
                let createTime = data.createTime;
                let createBy = data.createBy;
                let updateTime = data.updateTime;
                let updateBy = data.updateBy;
                let remark = data.remark;


                // 打开模态框
                layer.open({
                    type: 1,//类型
                    area: ['300px', '300px'],  //定义宽和高
                    title: '查看信息',  //题目
                    shadeClose: true,  //点击遮罩层关闭
                    content: $('#open_detail_div'),  //打开的内容
                });


                /**
                 * 时间戳转换为日期字符串方法
                 * @param {*} timesStamp   // 时间戳
                 * @param {*} datePattern  // 转换格式
                 * @returns
                 */
                function datesFormat(timesStamp, datePattern = '') {
                    return (new Date(parseInt(timesStamp)).format(datePattern ? datePattern : 'YYYY-MM-DD hh:mm:ss'))
                }

                Date.prototype.format = function (fmt) {
                    var o = {
                        "M+": this.getMonth() + 1,                 //月份
                        "D+": this.getDate(),                    //日
                        "h+": this.getHours(),                   //小时
                        "m+": this.getMinutes(),                 //分
                        "s+": this.getSeconds(),                 //秒
                        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                        "S": this.getMilliseconds()             //毫秒
                    }
                    if (/(Y+)/i.test(fmt)) {
                        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
                    }
                    for (var k in o) {
                        if (new RegExp("(" + k + ")").test(fmt)) {
                            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                        }
                    }
                    return fmt
                }

                let testBegin1 = datesFormat(testBegin, 'YYYY年MM月DD日 hh:mm:ss');
                let testEnd1 = datesFormat(testEnd, 'YYYY年MM月DD日 hh:mm:ss');
                let createTime1 = datesFormat(createTime, 'YYYY年MM月DD日 hh:mm:ss');
                let updateTime1 = datesFormat(updateTime, 'YYYY年MM月DD日 hh:mm:ss');


                let strTest = "http://chenmao.fun:88?id=" + id
                    + "&testName=" + testName
                    + "&testCode=" + testCode
                    + "&testBegin=" + testBegin1
                    + "&testEnd=" + testEnd1
                    + "&createTime=" + createTime1
                    + "&createBy=" + createBy
                    + "&updateTime=" + updateTime1
                    + "&updateBy=" + updateBy
                    + "&remark=" + remark;


                $("#qrcode").html('');  // 清空先前的二维码

                $("#qrcode").qrcode({
                    render: "canvas",  // 也可以是table
                    width: 200,
                    height: 200,
                    text: encodeURI(strTest),
                });


            }

        });


        // 批量删除数据
        $("#btn-remove").click(function () {
            let checkStatus = table.checkStatus('Userinfo');
            if (checkStatus.data.length == 0) {
                console.log("checkData===" + checkStatus.data);
                parent.layer.msg('请先选择要删除的数据行！', {icon: 2, time: 2000});
                return;
            }

            console.log("checkStatus===" + checkStatus.data.userId);

            // 对拿到的数据进行处理,转为字符串
            let strIds = '';
            for (let i = 0; i < checkStatus.data.length; i++) {
                strIds += checkStatus.data[i].userId + ';';
            }
            strIds = strIds.substring(0, strIds.length - 1);  // 去掉 ; 号

            // 弹出确认删除框
            layer.confirm('确认删除ID为 [' + strIds + '] 的题目吗?', function (index) {

                console.log("strIds===" + strIds)

                parent.layer.msg('删除中...', {icon: 16, shade: 0.3, time: 2000});

                $.ajax({
                    type: 'get',
                    url: "/delDataUser",
                    data: {
                        ids: strIds,
                    },
                    contentType: 'application/json',
                    success: function (data) {

                        console.log(data);

                        if (data !== 0) {
                            layer.closeAll('loading');  // 关闭加载动画
                            window.setTimeout(function () {  // 延时两秒后再执行方法体
                                layer.msg('删除成功！', {icon: 1}, {time: 1000});  // icon 为图标，time为弹出框消息停留时间
                            }, 2000);

                            $(".layui-laypage-btn").click();  //刷新数据
                        } else {
                            layer.closeAll('loading');  // 关闭加载动画
                            window.setTimeout(function () {
                                layer.msg('删除失败！', {icon: 2}, {time: 1000});
                            }, 2000);

                        }

                    }
                })

            })

        });


        // 添加
        $("#btn-add").click(function () {

            let form1 = layui.form;
            form1.val("add", {
                "dept": 13,
                "userName": '',
                "email": '',
                "phoneNumber": '',
                "sex": '',
                "password": '',
                "identity": 2,
                "remark": '',
            });


            // 打开模态框
            layer.open({
                type: 1,//类型
                area: ['500px', '600px'],  //定义宽和高
                title: '添加信息',  //题目
                shadeClose: true,  //点击遮罩层关闭
                content: $('#open_add_div'),  //打开的内容
                // btn: ['确定', '取消']
            });


            // 拿到修改后的数据，传给后端
            form1.on('submit(update_add_submit)', function (massage) {
                console.log("message为：", massage);
                console.log(massage.field);
                let data1 = massage.field;
                $.ajax({
                    type: "post",
                    url: "/addDataUser",
                    // data: JSON.stringify(massage.field),
                    data: {
                        "deptId": data1.dept,
                        "userName": data1.userName,
                        "email": data1.email,
                        "phoneNumber": data1.phoneNumber,
                        "sex": data1.sex,
                        "password": data1.password,
                        "roleId": data1.roleName,
                        "remark": data1.remark,

                        "createBy": "CSH",
                    },

                    success: function (msg) {
                        console.log(msg);
                        layer.closeAll();//关闭所有的弹出层
                        if (msg == 1) {
                            layer.msg("添加成功！", {icon: 6}, {time: 2000});

                            $(".layui-laypage-btn").click();  //刷新数据

                        } else {
                            layer.msg("添加失败！", {icon: 5}, {time: 2000});
                        }
                    }
                })


                return false

            })

        });


    });

</script>

</html>